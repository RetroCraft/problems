\documentclass[class=co432,notes,tikz]{agony}

\title{CO 432 Spring 2025: Lecture Notes}

\begin{document}
\renewcommand{\contentsname}{CO 432 Spring 2025:\\{\huge Lecture Notes}}
\thispagestyle{firstpage}
\tableofcontents

Lecture notes taken, unless otherwise specified,
by myself during the Spring 2025 offering of CO 432,
taught by Vijay Bhattiprolu.

\begin{multicols}{2}
  \listoflecture
\end{multicols}

\chapter{Introduction}

\begin{notation}
  I will be using my usual \LaTeX{} typesetting conventions:
  \begin{itemize}[nosep]
    \item $[n]$ means the set $\{1,2,\dotsc,n\}$
    \item $\bits*$ means the set of bitstrings of arbitrary length (i.e., the Kleene star)
    \item $\sum_i$ is implicitly $\sum_{i=1}^n$
    \item $\rv A, \rv B, \dotsc, \rv Z$ are random variables (in sans-serif)
    \item $\X \sim (p_1,p_2,\dotsc,p_n)$ means $\X$ is a
          discrete random variable with $n$ outcomes
          such that $\Pr[\X = 1] = p_1$, $\Pr[\X=2] = p_2$, etc.
          (abbreviate further as $\X \sim (p_i)$)
  \end{itemize}
\end{notation}

\section{Entropy}
\lecture{May 6}

\textrule{$\downarrow$ Lecture 1 adapted from Arthur $\downarrow$}

\begin{defn}[entropy]
  For a random variable $\X \sim (p_i)$,
  the \term*{entropy} $H(\X)$ is
  \[ H(\X) = -\sum_i p_i \log p_i = \sum_i p_i \log \frac{1}{p_i}. \]
\end{defn}

\begin{convention}
  By convention, we usually use $\log_2$.
  Also, we define entropy such that $\log_2(0) = 0$ so that
  impossible values do not break the formula.
\end{convention}

\begin{example}
  If $\X$ takes on the values $a$, $b$, $c$, $d$
  with probabilities 1, 0, 0, 0, respectively, then $H(\X) = 1 \log 1 = 0$.

  If $\X$ takes on those values instead with probabilities
  $\frac12$, $\frac14$, $\frac18$, $\frac18$, respectively,
  then $H(\X) = \frac74$.
\end{example}

\begin{fact}
  $H(\X) = 0$ if and only if $\X$ is a constant.
\end{fact}
\begin{prf}
  Suppose $\X$ is constant. Then, $H(\X) = 1 \log 1 = 0$.

  Suppose $H(\X) = 0$.
  Probabilities are in $[0,1]$, so $p_i \log \frac{1}{p_i} \geq 0$.
  Since $H(\X) = \sum_i p_i \log \frac{1}{p_i} = 0$
  and each term is non-negative, each term must be zero.
  Thus, each $p_i$ is either 0 or 1.
  We cannot have $\sum p_i > 1$, so exactly one $p_i = 1$ and the rest are zero.
  That is, $\X$ is constant.
\end{prf}

\begin{theorem}[Jensen's inequality]\label{thm:jensen}
  Let $f : \R \to \R$ be concave. That is,
  for any $a$ and $b$ in the domain of $f$ and $\lambda \in [0,1)$,
  $f(\lambda a + (1-\lambda)b) \geq \lambda f(a) + (1-\lambda)f(b)$.
  For any discrete random variable $\X$,
  \[ \E[f(\X)] \leq f(\E[\X]) \]
\end{theorem}
\begin{prf}
  Consider a random variable $\X$ with two values $a$ and $b$,
  each with probabilities $\lambda$ and $1-\lambda$.
  Then, notice that
  \[ \E[f(\X)] = \lambda f(a) + (1-\lambda) f(b) \leq f(\lambda a + (1-\lambda)b) = f(\E[\X]) \]
  by convexity of $f$.

  TODO: This can be generalized by induction.
\end{prf}

\begin{fact}
  Assume $\X$ is supported on $[n]$. Then, $0 \leq H(\X) \leq \log n$.
\end{fact}
\begin{prf}
  Start by claiming without proof that $\log n$ is concave, so we can apply
  \nameref{thm:jensen}.

  Let $\X' = \frac{1}{p_i}$ with probability $p_i$. Then,
  \begin{align*}
    H(\X) & = \sum_i p_i \log \frac{1}{p_i}    \\
          & = \E\qty[\log(\X')]                \\
          & \leq \log(\E[\X'])                 \\
          & = \log\qty(\sum p_i \frac{1}{p_i}) \\
          & = \log n \qedhere
  \end{align*}
\end{prf}

It is not a coincidence that $\log_2 n$ is the minimum number of bits to encode $[n]$.

\section{Entropy as expected surprise}

We want $S : [0,1] \to [0,\infty)$ to capture how ``surprised''
we are $S(p)$ that an event with probability $p$ happens.
We want to show that under some natural assumptions,
this is the only function we could have defined as entropy.
In particular:

\begin{enumerate}
  \item $S(1) = 0$, a certainty should not be surprising
  \item $S(q) > S(p)$ if $p > q$, less probable should be more surprising
  \item $S(p)$ is continuous in $p$
  \item $S(pq) =  S(p) + S(q)$, surprise should add for independent events.
        That is, if I see something twice, I should be twice as surprised.
\end{enumerate}

\textrule{$\uparrow$ Lecture 1 adapted from Arthur $\uparrow$}
\lecture{May 8}

\begin{prop}
  If $S(p)$ satisfies these 4 axioms, then $S(p)=c\cdot \log_2(1/p)$ for some $c > 0$.
\end{prop}
\begin{prf}
  Suppose a function $S : [0,1] \to [0,\infty)$ exists satisfying the axioms.
  Let $c := S(\frac12) > 0$.

  By axiom 4 (addition), $S(\frac{1}{2^k}) = kS(\frac12)$.
  Likewise, $S(\frac{1}{2^{1/k}}\cdots\frac{1}{2^{1/k}})
    = S(\frac{1}{2^{1/k}}) + \dotsb + S(\frac{1}{2^{1/k}}) = kS(\frac{1}{2^{1/k}})$.

  Then, $S(\frac{1}{2^{m/n}}) = \frac{m}{n}S(\frac12) = \frac{m}{n}\cdot c$
  for any rational $m/n$.

  By axiom 3 (continuity), $S(\frac{1}{2^z}) = c \cdot z$ for all $z \in [0,\infty)$
  because the rationals are dense in the reals.
  In particular, for any $p \in [0,1]$,
  we can write $p = \frac{1}{2^z}$ for $z = \log_2(1/p)$
  and we get \[ S\qty(p) = S\qty(\frac{1}{2^z}) = c \cdot z = c \cdot \log_2(1/p) \]
  as desired.
\end{prf}

We can now view entropy as expected surprise. In particular,
\[ \sum_i p_i \log_2\frac{1}{p_i} = \E_{x \sim \X}\qty[S(p_x)] \]
for a random variable $\X = i$ with probability $p_i$.

\section{Entropy as optimal lossless data compression}

Suppose we are trying to compress a string consisting of $n$
symbols drawn from some distribution.

\begin{restatable}{problem}{bitproblem}
  What is the expected number of bits you need to store the results of $n$ independent samples
  of a random variable $\X$?
\end{restatable}

We will show this is $nH(\X)$.

Notice that we assume that the symbols we are drawn \uline{independently},
which is violated by almost all data we actually care about.

\begin{restatable}{definition}{defcode}
  Let $C : \Sigma \to (\Sigma')^*$ be a code.
  We say $C$ is a \term[code!uniquely decodable]{uniquely decodable} code (UDC) if there does not exist
  a collision $x, y \in \Sigma^*$,
  with identical encoding $C(x_1)C(x_2)\cdots C(x_k) = C(y_1)C(y_2)\cdots C(y_{k'})$.

  Also, $C$ is \term[code!prefix-free]{prefix-free} (sometimes called \term*{instantaneous})
  if for any distinct $x,y \in \Sigma$, $C(x)$ is not a prefix of $C(y)$.
\end{restatable}

\begin{prop}
  Prefix-freeness is sufficient for unique decodability.
\end{prop}

\begin{example}
  Let $C : \{A,B,C,D\} \to \{0,1\}^*$ where
  $C(A) = 11$, $C(B) = 101$, $C(C) = 100$, and $C(D) = 00$.
  Then, $C$ is prefix-free and uniquely decodable.

  We can easily parse $1011100001100$ unambiguously as $101.11.00.00.11.00$
  ($BADDAD$).
\end{example}

Recall from CS 240 that a prefix-free code is equivalent to a trie,
and we can decode it by traversing the trie in linear time.

\begin{theorem}[Kraft's inequality]\label{thm:kraft}
  A prefix-free binary code $C : \{1,\dotsc,n\} \to \{0,1\}^*$
  with codeword lengths $\ell_i = \abs{C(i)}$ exists if and only if
  \[ \sum_{i=1}^n \frac{1}{2^{\ell_i}} \leq 1. \]
\end{theorem}
\begin{prf}
  Suppose $C : \{1,\dotsc,n\} \to \{0,1\}^*$ is prefix-free
  with codeword lengths $\ell_i$.
  Let $T$ be its associated binary tree
  and let $W$ be a random walk on $T$ where 0 and 1 have equal weight
  (stopping at either a leaf or undefined branch).

  Define $E_i$ as the event where $W$ reaches $i$ and
  $E_\varnothing$ where $W$ falls off. Then,
  \begin{align*}
    1 & = \Pr(E_\varnothing) + \sum_i \Pr(E_i)                                   \\
      & = \Pr(E_\varnothing) + \sum_i \frac{1}{2^{\ell_i}} \tag{by independence} \\
      & \geq \sum_i \frac{1}{2^{\ell_i}} \tag{probabilities are non-negative}
  \end{align*}

  Conversely, suppose the inequality holds for some $\ell_i$.
  \WLOG, suppose $\ell_1 < \ell_2 < \dotsb < \ell_n$.

  Start with a complete binary tree $T$ of depth $\ell_n$.
  For each $i = 1,\dotsc,n$, find any unassigned node in $T$ of depth $\ell_i$,
  delete its children, and assign it a symbol.

  Now, it remains to show that this process will not fail.
  That is, for any loop step $i$, there is still some unassigned node at depth $\ell_i$.

  Let $P \gets 2^{\ell_n}$ be the number of leaves
  of the complete binary tree of depth $\ell_n$.
  After the $i$\xth step, we decrease $P$ by $2^{\ell_n - \ell_i}$.
  That is, after $n$ steps,
  \begin{align*}
    P & = 2^{\ell_n} - \sum_{i=1}^n \frac{2^{\ell_n}}{2^{\ell_i}}   \\
      & = 2^{\ell_n} - 2^{\ell_n} \sum_{i=1}^n \frac{1}{2^{\ell_i}} \\
      & \geq 0
  \end{align*}
  by the inequality.
\end{prf}

\lecture{May 13}
Recall the problem we are trying to solve:
\bitproblem*
\begin{sol}[Shannon \& Faro]
  Consider the case where $\X$ is symbol $i$ with probability $p_i$.
  We want to encode independent samples $x_i \sim \X$
  as $C(x_i)$ for some code $C : [n] \to \bits*$.

  Suppose for simplification that $p_i = \frac{1}{2^{\ell_i}}$
  for some integers $\ell_i$.
  Since $\sum p_i = 1$, we must have $\sum \frac{1}{2^{\ell_i}} = 1$.
  Then, by \nameref{thm:kraft}, there exists a prefix-free binary code
  $C : [n] \to \bits*$ with codeword lengths $\abs{C(i)} = \ell_i$.
  Now,
  \[
    \E_{x_i \sim \X}\qty[\sum_i\abs{C(x_i)}] = \sum_i p_i\ell_i = \sum_i p_i\log_2\frac{1}{p_i} = H(\X)
  \]
  Proceed to the general case.
  Suppose $\log_2\frac{1}{p_i}$ are non-integral.
  Instead, use $\ell'_i = \ceil*{\log_2\frac{1}{p_i}}$.
  We still satisfy Kraft since $\sum_i \frac{1}{2^{\ell'_i}} \leq \sum_i p_i = 1$.
  Then,
  \[
    \E_{x_i \sim \X}\qty[\sum_i\abs{C(x_i)}] = \sum_i p_i\ell'_i = \sum_i p_i\ceil*{\log_2\frac{1}{p_i}}
  \]
  which is bounded by
  \[ H(\X) = \sum_i p_i\log_2\frac{1}{p_i} \leq \sum_i p_i\ceil*{\log_2\frac{1}{p_i}} < \sum_i p_i\qty(1+\log_2\frac{1}{p_i}) = H(\X) + 1 \]
  We call the code $C$ generated by this process the \term[code!Shannon--Faro]{Shannon--Faro code}.
\end{sol}

We can improve on this bound $[H(\X), H(\X) + 1)$
by amortizing over longer batches of the string.

\begin{sol}[batching]
  For $\Y$ defined on $[n]$ equal to $i$ with probability $q_i$,
  define the random variable $\Y^{(k)}$ on $[n]^k$
  equal to the string $i_1\cdots i_k$ with probability $q_{i_1}\cdots q_{i_k}$.
  That is, $\Y^{(k)}$ models $k$ independent samples of $\Y$.

  Apply the Shannon--Fano code to $\Y^{(k)}$
  to get an encoding of $[n]^k$ as bitstrings of expected length $\ell$
  satisfying $H(\Y^{(k)}) \leq \ell \leq H(\Y^{(k)}) + 1$.
  \begin{align*}
    H(\Y^{(k)}) & = \E_{i_1\cdots i_k \sim \Y^{(k)}}\qty[\log_2 \frac{1}{q_{i_1}\cdots q_{i_k}}] \tag{by def'n}                       \\
                & = \E_{i_1\cdots i_k \sim \Y^{(k)}}\qty[\log_2 \frac{1}{q_{i_1}} + \dotsb + \log_2\frac{1}{q_{i_k}}] \tag{log rules} \\
                & = \sum_{j=1}^k \E_{i_1\cdots i_k \sim \Y^{(k)}}\qty[\log_2 \frac{1}{q_{i_j}}] \tag{linearity of expectation}        \\
                & = \sum_{j=1}^k \E_{i \sim \Y}\qty[\log_2 \frac{1}{q_{i}}] \tag{$q_{i_j}$ only depends on one character}             \\
                & = kH(\Y) \tag{by def'n, no $j$-dependence in sum}
  \end{align*}
  For every $k$ symbols, we use $\ell$ bits, i.e., $\frac{\ell}{k}$ bits per symbol.
  From the Shannon--Faro bound, we have
  \begin{align*}
    \frac{H(\Y^{(k)})}{k} & \leq \frac{\ell}{k} < \frac{H(\Y^{(k)})}{k} + \frac{1}{k} \\
    H(\Y)                 & \leq \frac{\ell}{k} < H(\Y) + \frac{1}{k}
  \end{align*}
  Then, we have a code for $\Y$ bounded by
  $[H(\Y), H(\Y) + \frac{1}{k})$.

  Taking a limit of some sort, we can say that we need $H(\Y) + o(1)$ bits.
\end{sol}

\chapter{Relative entropy}
\begin{defn*}[relative entropy]
  Given two discrete distributions $p = (p_i)$ and $q = (q_i)$,
  the \term[entropy!relative]{relative entropy}
  \[ \D p q :=
    \sum p_i \log_2\frac{1}{q_i} - \sum_i p_i \log_2 \frac{1}{p_i}
    = \sum p_i \log_2 \frac{p_i}{q_i} \]
  This is also known as the \term{KL divergence}.
\end{defn*}

\lecture{May 15}
The KL divergence works vaguely like a ``distance'' between distributions.
(In particular, KL divergence is not a metric since it lacks symmetry
and does not follow the triangle inequality,
but it can act sorta like a generalized squared distance.)

\begin{fact}\label{fact:dnneg}
  $\D p q \geq 0$ with equality exactly when $p = q$.
\end{fact}
\begin{prf}
  % Define $\X' = \frac{p_i}{q_i}$ with probability $p_i$.
  % Then,
  % \[ \D p q = \E[-\log_2 \X'] \geq -\log_2 E[\X'] \]
  % by Jensen's inequality (as $f(x) = -\log_2 x$ is convex), and then
  % \[ \D p q \geq  -\log_2 \sum p_i \frac{q_i}{p_i} = -\log_2 1 = 0 \qedhere \]
  Observe that
  \[ -\D p q = \sum_i p_i(-\log_2\frac{p_i}{q_i}) = \sum_i p_i \log_2 \frac{q_i}{p_i} \]
  and then define $\X' = \frac{q_i}{p_i}$ with probability $p_i$.
  By construction, we get
  \[ -\D p q = \E[\log_2 \X'] \leq \log_2(\E[\X']) \]
  by \nameref{thm:jensen} (as $f = \log_2$ is concave).
  Finally,
  \[ \D p q \geq -\log_2(\E[\X']) = \log_2\qty(\sum_i p_i \frac{q_i}{p_i}) = \log_2 1 = 0  \qedhere \]
\end{prf}

\begin{prop}
  Any prefix-free code has an expected length at least $H(\X)$.
\end{prop}
\begin{prf}
  Let $\X \sim (p_i)$.
  Suppose $C$ is a prefix-free code with codeword lengths $\ell_i$.

  Then, by \nameref{thm:kraft}, $\sum_i 2^{-\ell_i} \leq 1$.
  We want to show that $\sum_i p_i \ell_i \geq H(\X)$,
  and we will prove this by showing that $\sum_i p_i \ell_i - H(\X) =
    \D p q$ for some distribution $q$
  (then apply \cref{fact:dnneg}).

  We will take $q$ to be the random walk distribution corresponding to the binary tree
  associated to the candidate prefix-free code.

  Let $T$ be the binary tree associated to $C$.
  Consider the process of randomly going left/right at each node
  and stopping when either falling off the tree or hitting a leaf.

  Let $q_i = 2^{-\ell_i}$ be the probability that this random walk reaches the leaf for the symbol $i$
  and let $q_{n+1} = 1-\sum_i 2^{-\ell_i}$ be the probability that the random walk falls off the tree.
  Also, to keep ranges identical, let $\tilde p_i = p_i$ and $\tilde p_{n+1} = 0$. Now,
  \begin{align*}
    \D{\tilde p}{q_C}
     & = \sum_{i=1}^{n+1} \tilde p_i \log_2 q_i^{-1} - \sum_{i=1}^{n+1} \tilde p_i \log_2 \frac{1}{p_i}      \\
     & = \sum_{i=1}^n p_i \log_2 2^{\ell_i} - \sum_{i=1}^n p_i \log_2 \frac{1}{p_i} \tag{$\tilde p_{n+1}=0$} \\
     & = \sum_{i=1}^n p_i \ell_i - H(\X)
  \end{align*}
  Therefore, by \cref{fact:dnneg}, $\sum_i p_i \ell_i \geq H(\X)$.
\end{prf}

This proof technique generalizes.
Recall the distinction between UDCs and prefix-free codes:

\defcode*

\begin{example}
  The code $C(1,2,3,4) = (10,00,11,110)$ is a uniquely decodable code.

  The code $C'(1,2,3,4) = (0,10,110,111)$ is a prefix-free code.
\end{example}

\begin{remark}
  A natural additional requirement for unique decodability
  is that for any $k \in \N$, $x \in [n]^k$, $y \in [n]^k$, $C(x) \neq C(y)$.
\end{remark}

\begin{theorem}
  For any uniquely decodable code $C : [n] \to \bits*$ of codeword lengths $\ell_i$,
  there is also a prefix-free code $C' : [n] \to \bits*$ of lengths $\ell_i$.
\end{theorem}

We will show that for any UDC $C$, the lengths $\sum_i 2^{-\ell_i} \leq 1$.
Then, \nameref{thm:kraft} applies and we have a prefix-free code $C'$.

Partition the code's codomain $C([n]) = C_1 \cup C_2 \cup C_3 \cup \cdots$
by the length of the codeword $C_j \subseteq \bits{j}$.
We must instead show $\sum_j \frac{\abs{C_i}}{2^j} \leq 1$.

Consider the easy case $C([n]) = C_2 \cup C_3$.
If there are no collisions of length 5,
we have \[ 2 \cdot \abs{C_2} \cdot \abs{C_3} \leq 2^5 \]
because every string in $\{xy : x \in C_2, y \in C_3\} \cup \{yx : x \in C_2, y \in C_3\}$
is unique in $\bits{5}$.
That is, $\abs{C_2} \cdot \abs{C_3} \leq 2^4$.

Likewise, if there are no collisions of length $5k$, we get
\[ \frac{(2k)!}{k! \cdot k!} \cdot \abs{C_2}^k \cdot \abs{C_3}^k \leq 2^{5k} \]
because the union
$\displaystyle\bigcup_{\mathclap{\substack{\alpha \in \{2,3\}^{2k}, \\ \alpha_i = 2\text{ for} \\ \text{$k$ choices of $i$}}}} C_{\alpha_i}$
consists of only unique strings.

In the limit, by \nameref{thm:sterling},
\begin{align*}
  \frac{2^{2k}}{\sqrt{k}} \cdot \abs{C_2}^k \cdot \abs{C_3}^k & \leq 2^{5k}                                                         \\
  \abs{C_2}\cdot\abs{C_3}                                     & \leq \frac{2^5}{2^2}(\sqrt{k})^{1/k} \approx 1 + \order{\log k / k}
\end{align*}
I have no idea where this was going.

\begin{prf}
  Fix a $k \geq 1$. Let $\ell_{max} = \max \ell_i$.
  Write $C^{(k)}$ to be the set of encoded $k$-length strings.

  Consider the distribution:
  sample a length $m$ uniformly from the set $[k\cdot \ell_{max}]$.
  Also, sample a uniformly random string $s \in \bits{m}$.
  For each $x \in C^{(k)}$, let $E_x$ be the event where $s = x$.

  Now, we can write
  \begin{align*}
    \sum_{x \in C^{(k)}} \Pr[E_x]                                               & \leq 1                \\
    \intertext{because the events $E_x$ are mutually exclusive. Then,}
    \sum_{x \in C^{(k)}} \frac{1}{k\cdot\ell_{max}} \cdot \frac{1}{2^{\ell(x)}} & \leq 1                \\
    \sum_{x \in C^{(k)}} \frac{1}{2^{\ell(x)}}                                  & \leq k\cdot\ell_{max}
  \end{align*}
  where $\ell(x)$ is the length of $x$. Since summing over each codeword $x \in C$
  is the same as summing over each codeword $\ell_i$,
  \begin{align*}
    \qty(\sum_i \frac{1}{2^{\ell_i}})^k
     & = \qty(\sum_{x \in C}\frac{1}{2^{\ell(x)}})^k                                                                      \\
     & = \sum_{x_1,\dotsc,x_k \in C} \frac{1}{2^{\ell(x_1)}} \cdot \frac{1}{2^{\ell(x_2)}} \cdots \frac{1}{2^{\ell(x_k)}} \\
     & = \sum_{x_1,\dotsc,x_k \in C} \frac{1}{2^{\ell(x_1) + \ell(x_2) + \dotsb + \ell(x_k)}}                             \\
     & = \sum_{x_1,\dotsc,x_k \in C} \frac{1}{2^{\ell(x_1x_2 \cdots x_k)}}                                                \\
     & = \sum_{x \in C^{(k)}} \frac{1}{2^{\ell(x)}}
  \end{align*}
  where we can take the last step by uniquely decoding $x_1x_2\cdots x_k$ into $x$.
  Combining,
  \begin{align*}
    \qty(\sum_i \frac{1}{2^{\ell_i}})^k & \leq k \cdot \ell_{max}                            \\
    \sum_i \frac{1}{2^{\ell_i}}         & \leq (k \cdot \ell_{max})^{\frac{1}{k}}            \\
                                        & \leq 1 + \order{\frac{\ell_{max}\cdot\log_2 k}{k}}
  \end{align*}
  which tends to 1 as $k \to \infty$, as desired.
\end{prf}

\lecture{May 20}

\begin{notation}
  Write $H(p)$ to denote $H(\X)$ for $\X \sim \Bern(p)$.

  That is, $H(p) = p\log_2\frac1p + (1-p)\log_2\frac{1}{1-p}$.

  Likewise, write $\D q p$ to be $\D{\Y}{\X}$
  where $\Y \sim \Bern(q)$.
\end{notation}

Recall Sterling's approximation (which we have used before):

\begin{theorem}[Sterling's approximation]\label{thm:sterling}
  $m!$ behaves like $\sqrt{2\pi m}\qty(\frac{m}{e})^m\qty(1+\order{\frac{1}{m}})$
\end{theorem}

\section{The boolean $k$-slice}
Consider the \term{boolean $k$-slice} (also known as the \term{Hamming $k$-slice})
of the hypercube $\bits{n}$ defined by
\[ B_k := \{x \in \bits{n} : \text{$x$ has exactly $k$ ones}\} \]
\begin{remark}
  \[ \abs{B_k} \approx 2^{H(\frac{k}{n})\cdot n} \]
\end{remark}
\begin{prf}
  By \nameref{thm:sterling}, knowing that $\abs{B_k} = \binom{n}{k}$:
  \begin{align*}
    \abs{B_k} & = \binom{n}{k}                                                                                                             \\
              & = \frac{n!}{n!(n-k)!}                                                                                                      \\
              & \approx \frac{\sqrt{2\pi n}\qty(\frac{n}{e})^n}{\sqrt{2\pi k}\qty(\frac{k}{e})^k\sqrt{2\pi(n-k)}\qty(\frac{n-k}{e})^{n-k}} \\
              & = \sqrt{\frac{n}{2\pi k(n-k)}} \cdot \frac{n^k\qty(\frac{n}{n-k})^{n-k}}{k^k}
  \end{align*}
  Now, notice that $\qty(\frac{n}{n-k})^{n-k} = \qty(1+\frac{k}{n-k})^{n-k} \approx e^k$
  for $k \ll n-k$ because $1+x \approx e^x$ for small $x$.
  Then, $\qty(1+\frac{k}{n-k})^{n-k} \approx \qty(e^{k/(n-k)})^{n-k} = e^k$ and
  \begin{align*}
    \abs{B_k} & \approx \qty(\frac{ne}{k})^k \nr{eq:borgor}       \\
              & = 2^{k \log_2 \frac{ne}{k}}                       \\
              & = 2^{k\log_2 \frac{n}{k} + k\log_2 e}             \\
              & = 2^{(\frac{k}{n}\log_2\frac{n}{k})n + k\log_2 e} \\
              & \approx 2^{(\frac{k}{n}\log_2\frac{n}{k})n}
  \end{align*}
  for $1 \ll k \ll n$. Then, given that same assumption,
  \begin{align*}
    H\qty(\frac{k}{n})
     & = \frac{k}{n} \log_2 \frac{n}{k} + \cancelto{0}{\qty(1-\frac{k}{n}) \log_2\frac{1}{1-\frac{k}{n}}} \\
     & \approx \frac{k}{n} \log_2 \frac{n}{k}
  \end{align*}
  because if $n \gg k$, $\frac{k}{n} \to 0$ and $1\log_2 1 = 0$.
  Combining these approximations yields
  \[ \abs{B_k} \approx 2^{H(\frac{k}{n})n} \qedhere \]
\end{prf}

Let $\X$ be a uniformly chosen point in $B_k$
and $\X_1,\dotsc,\X_n \sim \Bern(\frac{k}{n})$.

This means that $H(\X) \approx H((\X_1,\dotsc,\X_n))$,
which is remarkable because the latter could produce points in $B_k$
or points with $n$ ones or points with no ones.

This seems to imply that the majority of the mass of $(\X_1,\dotsc,\X_n)$
lies within the boolean $k$-slice.
Formally, we make the following claim about the
\term{concentration of measure}:\footnote{cf. Dvoretzky--Milman theorem}

\begin{prop}
  Fix any $\varepsilon > 0$. The probability
  \[ \Pr\qty[(\X_1,\dotsc,\X_n) \not\in \bigcup_{\ell = (1-\varepsilon k)}^{(i+\varepsilon)k}B_\ell] = \frac{1}{2^{n/\varepsilon^2}} \]
  Informally, the probability of the randomly-drawn vector lying outside of
  the boolean $k$-slice is exponentially small.
\end{prop}

We will prove a stronger claim:

\begin{claim}
  Fix any $p \in (0,1)$ and consider any $q > p$. Then,
  \[ \Pr[w((\X_i)) > q \cdot n] \leq 2^{-\D q p \cdot n} \]
  where $w((\X_i))$ is the number of ones. Likewise, consider any $q < p$. Then,
  \[ \Pr[w((\X_i)) < q \cdot n] \leq 2^{-\D q p \cdot n} \]
\end{claim}

Consider a toy example first.
Let $\X$ be the number of heads after $n$ fair coin tosses.

Then, $\E[\X] = \frac{n}{2}$ and
\[
  \Pr[\X \geq 0.51n]
  = \frac{1}{2^n}\sum_{k\geq0.51n}^n\binom{n}{k}
  \approx \frac{1}{2^n}\sum_{k\geq0.51n}^n\qty(\frac{ne}{k})^k
  \to 0 \text{ very quickly}
\]
by the same magic that we did in \cref{eq:borgor}
and because $\frac{1}{2^n}$ goes to 0 very quickly.

Now we can prove the claim.

\begin{prf}
  Let $\theta_p(x)$ denote the probability of sampling a vector $x \in \bits{n}$
  where each bit is \iid $\Bern(p)$.
  Then,
  \begin{align*}
    \frac{\theta_p(x)}{\theta_q(x)}
     & = \frac{p^k(1-p)^k}{q^k(1-q)^k}                                            \\
     & = \frac{(1-p)^n}{(1-q)^n}\qty(\frac{\frac{p}{1-p}}{\frac{q}{1-q}})^k       \\
     & \leq \frac{(1-p)^n}{(1-q)^n}\qty(\frac{\frac{p}{1-p}}{\frac{q}{1-q}})^{qn}
  \end{align*}
  for any $k \geq qn$ because (1)
  if $q \geq p$, then $\frac{q}{1-q} \geq \frac{p}{1-p}$
  and the ugly fraction is greater than 1
  and (2) increasing the exponent increases the quantity if the base is greater than 1.

  Let $B_{\geq k} := \bigcup_{\ell \geq k} B_\ell$.
  Then, for all $x \in B_{\geq qn}$, we must show that
  \begin{align*}
    \theta_p(x) \leq \frac{(1-p)^n}{(1-q)^n}\qty(\frac{\frac{p}{1-p}}{\frac{q}{1-q}})^{qn} \cdot \theta_q(x)
    = 2^{-n\D q p\cdot \theta_q(x)}
  \end{align*}
  Consider the right-hand expression:
  \begin{align*}
    2^{n \cdot \D q p}
     & = 2^{n \cdot (q\log_2\frac1p + (1-q)\log_2\frac{1}{1-p} - q\log_2\frac1q - (1-q)\log_2\frac{1}{1-q})} \\
     & = \qty(\frac{1}{p^q} \cdot \frac{1}{(1-p)^{1-q}} \cdot q^q \cdot (1-q)^{1-q})^n                       \\
  \end{align*}
  and the left-hand expression:
  \begin{align*}
    \frac{(1-p)^n}{(1-q)^n}\qty(\frac{\frac{p}{1-p}}{\frac{q}{1-q}})^{qn}
     & = \qty(\frac{(1-p)^{1-q}p^q}{(1-q)^{1-q}q^q})^n                                 \\
     & = \qty(p^q \cdot (1-p)^{1-q} \cdot \frac{1}{q^q} \cdot \frac{1}{(1-q)^{1-q}})^n
  \end{align*}
  which is clearly the reciprocal of the right-hand expression.

  Now, we know that $\theta_p(x) = 2^{-n\D q p}\theta_q(x)$, so
  \begin{align*}
           & \Pr_{\X_1,\dotsc,\X_n \sim \Bern(p)}[(\X_1,\dotsc,\X_n) \in B_{\geq qn}] \\
    ={}    & \sum_{\mathclap{x \in B_{\geq qn}}} \theta_p(x)                          \\
    \leq{} & 2^{-n\D q p}\sum_{\mathclap{x \in B_{\geq qn}}}\theta_q(x)               \\
    \leq{} & 2^{-n\D q p}
  \end{align*}
  since the sum of the probabilities of $x$ being any given entry in $B_{\geq qn}$
  must be at most 1.
\end{prf}

\section{Rejection sampling}

The KL divergence can give us a metric of how accurately we can sample
one distribution using another distribution.

\begin{example}
  Suppose $\X = \begin{cases}
      0 & p=\frac12 \\
      1 & p=\frac12
    \end{cases}$ and $\Y = \begin{cases}
      0 & p=\frac14 \\
      1 & p=\frac34
    \end{cases}$.

  How can we sample $\Y$ using $\X$?
\end{example}
\begin{sol}[naive]
  Take \iid $\X_1$ and $\X_2$.
  Return 0 if $x_1 = x_2 = 0$ and 1 otherwise.
\end{sol}
\begin{sol}[fancy]
  Take an infinite \iid queue $\X_1,\X_2,\dotsc$

  Starting at $i = 1$, if $\X_i = 0$, then output 0 with probability $\frac12$,
  otherwise increment $i$ until $\X_i = 1$.
\end{sol}

\textrule{$\downarrow$ Lecture 6 adapted from Arthur $\downarrow$}

\lecture{May 22}
\begin{problem}[rejection sampling]
  Given access to a distribution $Q = (Q(x))_{x \in \XX}$,
  how efficiently can you simulate $P = (P(x))_{x \in \XX}$?
\end{problem}

\begin{example}
  Suppose $Q = (\frac13,\frac13,\frac13)$ and $P = (\frac12,\frac12)$.
  We want to obtain the $P$ distribution from $Q$.
\end{example}
\begin{sol}
  Since $Q$ and $P$ are both uniform, we can just keep sampling from $Q$
  until we get something in $P$. That is, for $i = 1,\dotsc,\infty$:
  \begin{enumerate}
    \item Sample $\X_i \sim Q$.
    \item If $\X_i \in \{1,2\}$, accept and output $\Y \gets \X_i$.
    \item Otherwise, $i \gets i + 1$.
  \end{enumerate}
  This works because
  \[ \Pr[\Y = 1] = \Pr[\X_i = 1 \mid \X_i = 1 \lor \X_i = 2] = \frac{1/3}{2/3} = \frac12 \]
  for the final round $i$, and similarly for $\Y = 2$.
\end{sol}

\begin{example}
  Consider a slightly more complex distribution $P = (\frac13,\frac23)$
  and $Q = (\frac12,\frac12)$.
\end{example}
\begin{sol}
  We will create a more complex rejection sampling protocol with some cheating.

  Again, iterate and draw independent $\X_i$:
  \begin{itemize}
    \item If $\X_1 = 1$, accept with probability $\frac23$.
          Otherwise, reject and continue to $\X_2$ with probability $\frac13$.
    \item If $\X_1 = 2$, accept.
    \item For $i \geq 2$, accept if $\X_i = 1$ and reject if $\X_i = 2$.
  \end{itemize}
  Then, the probability of accepting $\X_1 = 1$ is $\frac13$,
  $\X_1 = 2$ is $\frac12$, and rejecting $\X_1$ is $\frac16$.

  Since later rounds only output 1,
  we output 1 with probability $\frac13 + \frac16 = \frac12$
  and 2 with probability $\frac12$.
\end{sol}

\begin{defn}[rejection sampler]
  A \term{rejection sampler} is a procedure that reads sequentially independent
  random samples $\X_i \sim Q$ and in each round $i$ either
  \begin{itemize}[nosep]
    \item accepts the value of $\X_i$ and terminates with an index $i^*$, or
    \item rejects and continues.
  \end{itemize}

  The iteration we terminated on $i^*$ is a random variable
  since it is a function of other random variables. It satisfies
  $\X_{i^*} \sim P$, which is weird since for all fixed $i$, $\X_i \sim Q$.
\end{defn}

An interesting application is communication complexity.
Suppose Alice has some hidden distribution $P$.
Alice and Bob have access to a shared random \iid sequence $\X_i \sim Q$.

Alice can send an encoding of $i^*$ to Bob who outputs $\X_{i^*} \sim P$.
This encoding $i^*$ can be encoded using $\log i^*$ bits.

We will show that $\E[\log i^*] \leq \D P Q + \order{1}$.
You can also show that $\D P Q \leq \E[\log i*]$.

For each round $i$ and symbol $x$,
we need to know whether $x$ was sampled before round $i$,
i.e., the probability assigned to $x$ in previous rounds.

For round $i \geq 1$, define:
\begin{itemize}[nosep]
  \item $\alpha_i(x)$ to denote the probability that the procedure accepts $\X_i$ and that $\X_i = x$
  \item $p_i(x)$ to denote the probability that the procedure halts at round $i^* \leq i$ and $\X_{i^*} = x$
\end{itemize}

We want to construct our procedure such that
\begin{itemize}[nosep]
  \item for all $x$, $P(x) = \sum_{i=1}^n \alpha_i(x)$
  \item for all $x$ and $i$, $p_i(x) = \sum_{k=1}^i \alpha_k(x)$
  \item the probability that we halt on or before round $i$ is $p_i^* := \sum_{x \in \XX} p_i(x)$
\end{itemize}

% Then:
% - probability that procedure gets to iteration $i$ and satisfies $X_i=x$ is $(1-p^*_{i-1}) Q(x)$
% 	- $Q(x)$ is the chance that the distribution $Q$ outputs $x$
% 	- this does not necessarily mean that we output it
% - deficit probability of $x$ at round $i$ is
% 	- $P(x) - p_{i-1}(x)$ 
% 		- $P(x)$ is our target
% 		- $p_{i-1}(x)$ is the previous accumulated probability
% - If $(1-p^*_{i-1}) Q(x) > P(x)-p_{i-1}(x)$, 
% 	- then we want $\alpha_i(x) = P(x)-p_{i-1}(x)$ (we never want to exceed the target $P(x)$?)
% 		- this does not prescribe an action
% 	- otherwise we want to always accept, so $\alpha_i(x) = (1-p^*_{i-1}) Q(x)$
% 		- 100% conditioned on getting to round $i$ and sampling $x$
% 	- Therefore: $\alpha_i(x)\coloneqq \min(P(x)-p_{i-1}(x), (1-p_{i-1}^*)Q(x))$
% - 

% Define rejection sampler as:
% ```
% for i = 1 to infty:
% 	Sample X_i ~ Q
% 	If X_i == x:
% 		With probability beta_i(X_i) output i and halt
% 		otherwise continue

% ```

% Define: $\beta_i(X_i) = \frac{\alpha_i(X_i)}{(1-p^*_{i-1})Q(X_i)}$
% - Therefore, the bias of the coin (aka this beta_i x_i) changes on each round
% 	- but we only flip a coin once

\textrule{$\uparrow$ Lecture 6 adapted from Arthur $\uparrow$}

\lecture{May 27}
\begin{algorithm}[H]
  \caption{\Call{RejectionSampling}{$P$, $Q$}}
  \begin{algorithmic}[1]
    \Require{$\forall x \in \XX, Q(x) > 0 \iff \D P Q < \infty$}
    \For{$x \in \XX$} $p_0(x) \gets 0$ \EndFor
    \State $p_0^* \gets 0$
    \For{$i = 1,\dotsc,\infty$}
      \State sample $\X_i \sim Q$
      \If{$P(\X_i) - P_{i-1}(\X_i) \leq (1-p^*_{i-1})\cdot Q(\X_i)$}
        \Prob{$\beta_i(\X_i) = \frac{P(\X_i) - p_{i-1}(\X_i)}{(1-p_{i-1}^*)(Q(\X_i))}$}
          \LComment{so that the net probability of sampling $\X_i$ will be $\alpha_i(\X_i) = P(\X_i) - p_{i-1}(\X_i)$}
          \State \Return $\X_i$
        \EndProb
      \Else{}
        \Prob{$\beta_i(\X_i) = 1$}
          \LComment{so that the net probability of sampling $\X_i$ is $\alpha_i(1-p_{i-1}^*)\cdot Q(\X_i)$}
          \State \Return $\X_i$
        \EndProb
      \EndIf
    \EndFor
  \end{algorithmic}
\end{algorithm}

In this case, for all $x$ and for all $i$:
\begin{itemize}[nosep]
  \item the probability of accepting $x$ in round $i$
        is $\alpha_i(x) = \min\{P(x) - p_{i-1}(x), (1-p_{i-1}^*)Q(x)\}$
  \item the probability of accepting $x$ on or before round $i$ is
        $p_i(x) = p_{i-1}(x) + \alpha_i(x)$
  \item the probability of terminating on or before round $i$ is
        $p_i^* = p_{i-1}^* + \sum_{x \in \XX} \alpha_i(x) = \sum_{x \in \XX} p_i(x)$
\end{itemize}

\begin{example}
  Let $P = (\frac12,\frac38,\frac18)$ and $Q = (\frac13,\frac13,\frac13)$.
  Do the procedure.
\end{example}
\begin{sol}
  In round 1, sample $\X_1 \sim Q$.
  \begin{itemize}[nosep]
    \item If $\X_1 = 1$, accept with probability 1.
    \item If $\X_1 = 2$, accept with probability 1.
    \item If $\X_1 = 3$, accept with probability $\frac38$.
  \end{itemize}
  Then, $p_1(1) = \frac13$, $p_1(2) = \frac13$, $p_1(3) = \frac18$, and $p_1^* = \frac{19}{24}$.

  In round 2, sample $\X_2 \sim Q$.
  \begin{itemize}[nosep]
    \item If $\X_2 = 1$, accept with probability 1.
          There is a $\frac{5}{72}$ chance of getting here,
          but deficit probability is $\frac16$, so no need to reduce.
    \item If $\X_2 = 2$, accept with probability $\frac35$.
          There is a $\frac{5}{72}$ chance of getting here and
          deficit probability is $\frac38 - \frac13 = \frac{1}{24}$.
          For equality, use probability $\frac{3}{5}\cdot\frac{5}{72} = \frac{1}{24}$.
    \item If $\X_3 = 3$, accept with probability 0.
          We already fulfilled $P(3) = p_1(3)$.
  \end{itemize}
  Then, $p_2(1) = \frac{29}{72}$, $p_2(2) = \frac38$, $p_3(2) = \frac18$,
  and $p_2^* = \frac{19}{24} + \frac{5}{24}\cdot(\frac13+\frac{3/5}{5}) = \frac{65}{72}$.

  In round 3, sample $\X_3 \sim Q$.
  \begin{itemize}[nosep]
    \item If $\X_3 = 1$, accept with probability 1.
    \item If $\X_3 = 2$ or 3, accept with probability 0.
  \end{itemize}
  Keep repeating until we accept a 1.
\end{sol}

\begin{prop}
  $(p_i(x))_{x \in \XX}$ converges to $P(x)$ as $i \to \infty$.
  In fact, the residual decays exponentially fast
  \[ P(x) - p_i(x) \leq P(x) \cdot (1-Q(x))^i. \]
\end{prop}
\begin{prf}
  Begin with the claim that the probability of reaching round $i$
  is at least the residual at $i$ for any $x$:
  \[ 1-p_{i-1}^* \geq P(x) - p_{i-1}(x) \quad \forall x \]
  Intuitively, either you returned prior to round $i$ (i.e., $p_{i-1}^*$)
  or you did not (i.e., the residual).
  \begin{align*}
    1 - p_{i-1}^*
     & = \sum_{x \in \XX} P(x) - \sum_{x \in \XX} p_{i-1}(x)    \\
     & = \sum_{x \in \XX} (P(x) - p_{i-1}(x)) \nr{eq:subclaim1}
  \end{align*}
  Also, claim that
  \[ \alpha_i \geq (P(x) - p_{i-1}(x))\cdot Q(x) \nr{eq:subclaim2} \]
  If $\alpha_i = P(x) - p_{i-1}(x)$, then clearly $\alpha_i \geq \alpha_i Q(x)$.
  Otherwise, if $\alpha_i = (1-p_{i-1}^*)Q(x)$, then \cref{eq:subclaim1} applies.

  Proceed by induction.

  Base case: exercise.

  Inductive step: suppose that
  $P(x) - p_i(x) \leq P(x) \cdot (1-Q(x))^i$. Then,
  \begin{align*}
    P(x) - p_{i+1}(x)
     & = P(x) - p_i(x) - \alpha_{i+1}(x)                             \\
     & \leq (P(x) - p_{i-1}(x))(1-Q(x)) \tag{by \cref{eq:subclaim2}} \\
     & \leq (P(x) \cdot (1-Q(x))^i)(1-Q(x)) \tag{by supposition}     \\
     & \leq P(x) \cdot (1-Q(x))^{i+1} \qedhere
  \end{align*}
\end{prf}

Now, we will prove that this is related to relative entropy.

\begin{prop}\label{prop:rejworst}
  Let $i^*$ be the iteration at which the procedure returns.
  Then, $\E[\log_2 i^*] \leq \D P Q + 2\log_2 e$.
\end{prop}
\begin{prf}
  First, claim that for all $x \in \XX$ and any $i \geq 2$
  such that $\alpha_i(x) > 0$,
  \[ i \leq \frac{P(x)}{(1-p_{i-1}^*) \cdot Q(x)} + 1 \nr{eq:maxi} \]
  That is, if we reach a particular round $i$,
  the probability mass left must be sufficiently large.

  We know that $P(x) \geq p_{i-1}(x)$ since we increase to $P(x)$. Then,
  \begin{align*}
    P(x) & \geq p_{i-1}(x)                                               \\
         & = \alpha_1(x) + \dotsb + \alpha_{i-1}(x)                      \\
         & \geq (1-p_1^*)\cdot Q(x) + \dotsb + (1-p_{i-1})\cdot Q(x)     \\
         & \geq (1-p_{i-1}^*)\cdot Q(x) + \dotsb + (1-p_{i-1})\cdot Q(x) \\
         & = (i-1)(1-p_{i-1}^*)\cdot  Q(x)                               \\
    i    & \leq \frac{P(x)}{(1-p_{i-1}^*) \cdot Q(x)} + 1
  \end{align*}
  as long as $\alpha_{j-1} < \alpha_j$ for all $j$.

  \lecture{May 29}
  Do a gigantic algebra bash:
  \begin{align*}
    \E[\log_2 i^*]
     & = \sum_{i=1}^\infty (p_i^* - p_{i-1}^*) \cdot \log_2 i                                                                                                                                     \\
     & = \sum_{i=1}^\infty \sum_{x\in\XX} \alpha_i(x) \cdot \log_2 i                                                                                                                              \\
     & \leq \sum_{i=1}^\infty \sum_{x\in\XX} \alpha_i(x) \cdot \log_2 \qty[\frac{P(x)}{(1-p_{i-1}^*) Q(x)}+1] \tag{by \cref{eq:maxi}}                                                             \\
     & \leq \sum_{i=1}^\infty \sum_{x\in\XX} \alpha_i(x) \cdot \log_2 \qty[\frac{1}{(1-p_{i-1}^*)}\qty(\frac{P(x)}{Q(x)}+1)]                                                                      \\
     & = \underbrace{\sum_{i=1}^\infty \sum_{x\in\XX} \alpha_i(x) \log_2 \frac{1}{(1-p_{i-1}^*)}}_A + \underbrace{\sum_{i=1}^\infty \sum_{x\in\XX} \alpha_i(x) \log_2\qty(\frac{P(x)}{Q(x)}+1)}_B
  \end{align*}
  Consider the first term $A$:
  \begin{align*}
    A & = \sum_{i=1}^\infty \sum_{x\in\XX}\alpha_i(x) \log_2 \frac{1}{(1-p_{i-1}^*)} \\
      & = \sum_{i=1}^\infty (p_i^*-p_{i-1}^*) \log_2\frac{1}{(1-p_{i-1}^*)}
    \intertext{Notice that this is a left-handed Riemann sum of $\log_2\frac{1}{1-x}$:}
    A & \leq \int_0^1 \log_2\frac{1}{1-x} \dd{x}                                     \\
      & = \log_2 e
  \end{align*}
  Now, consider the second term $B$:
  \begin{align*}
    B & = \sum_{i=1}^\infty \sum_{x\in\XX} \alpha_i(x) \log_2\qty(\frac{P(x)}{Q(x)}+1)                            \\
      & = \sum_{x\in\XX} \sum_{i=1}^\infty  \alpha_i(x) \log_2\qty(\frac{P(x)}{Q(x)}+1) \tag{Fubini?}             \\
      & = \sum_{x\in\XX} P(x) \log_2\qty(\frac{P(x)}{Q(x)}+1)\tag{$P(x)=\sum_i \alpha_i(x)$}                      \\
      & = \sum_{x\in\XX} P(x) \log_2\qty(\frac{P(x)}{Q(x)}\cdot\qty(1+\frac{Q(x)}{P(x)}))                         \\
      & = \sum_{x\in\XX} P(x) \log_2\qty(\frac{P(x)}{Q(x)}) + \sum_{x\in\XX} P(x) \log_2\qty(1+\frac{Q(x)}{P(x)}) \\
      & = \D P Q + \sum_{x\in\XX} P(x) \log_2\qty(1+\frac{Q(x)}{P(x)})                                            \\
      & \leq \D P Q + \sum_{x\in\XX} P(x) \log_2\qty(e^{Q(x)/P(x)}) \tag{$1+x\leq e^x$ for all $x \geq 0$}        \\
      & = \D P Q + \sum_{x\in\XX} P(x) \frac{Q(x)}{P(x)}\log_2 e                                                  \\
      & = \D P Q + \log_2 e\sum_{x\in\XX} Q(x)                                                                    \\
      & = \D P Q + \log_2 e
  \end{align*}
  Therefore,
  \[ \E[\log_2 i^*] \leq A + B \leq \D P Q + 2\log_2 e \]
  completing the proof.
\end{prf}

Intuition: for any $x\in\XX$, if $\alpha_i(x)\leq Q(x) \lll P(x)$,
then you need an expected amount of $\frac{P(x)}{Q(x)}$ steps to succeed,
because you just won't roll $x$ that often.

Also, if $\alpha_{i+1}(x)>0$ (any round prior to termination),
$(1-p_{i-1}^*(x))Q(x) \leq \alpha_i(x)$.

\begin{prop}\label{prop:rejbest}
  For any rejection sampler, let $i^*$ be the index where it returns. Then,
  \[ \E[\ell(i^*)] \geq \D P Q \]
\end{prop}
\begin{prf}
  For convenience, redefine $\alpha_i(x) \coloneqq \Pr[i^* = i \land \X_i = x]$.

  First, observe that for any $x\in\XX$, a rejection sampler must have
  \[ \alpha_i(x) \leq Q(x) \]
  because we only have a $Q(x)$ chance of rolling $x$ to accept it in round $i$.

  Now, fix $x\in\XX$. Consider the random variable $i^*|_{\X_{i^*}=x}$.
  Then, by \nameref{thm:kraft},
  \begin{align*}
    \E[\ell(i^*) \mid \X_{i^*}=x]
     & \geq H(i^* \mid \X_{i^*}=x)                                                             \\
     & = \sum_{i=1}^\infty \Pr[i^*=i\mid \X_{i^*}=x]\log_2\frac{1}{\Pr[i^*=i \mid \X_{i^*}=x]} \\
     & = \sum_{i=1}^\infty \frac{\alpha_i(x)}{P(x)}\log_2\frac{P(x)}{\alpha_i(x)}              \\
     & \geq \sum_{i=1}^\infty \frac{\alpha_i(x)}{P(x)}\log_2\frac{P(x)}{Q(x)}                  \\
     & = \log_2\frac{P(x)}{Q(x)} \cdot \sum_{i=1}^\infty \frac{\alpha_i(x)}{P(x)}              \\
     & = \log_2\frac{P(x)}{Q(x)}
  \end{align*}
  because $\sum_{i=1}^\infty \alpha_i(x) = P(x)$.
  Apply the law of total probability:
  \begin{align*}
    \E[\ell(i^*)] & = \sum_{x\in \XX} \Pr[\X_{i*}=x] \E[\ell(i^*) \mid \X_{i^*}=x] \\
                  & = \sum_{x\in \XX} P(x) \E[\ell(i^*) \mid \X_{i^*}=x]           \\
                  & \geq \sum_{x\in \XX} P(x) \log_2 \frac{P(x)}{Q(x)}             \\
                  & = \D P Q
  \end{align*}
  as desired.
\end{prf}

\chapter{Mutual information}

\section{Definition and chain rules}
\lecture{June 3}
\begin{notation}
  Given two jointly distributed random variables $(\X,\Y)$ over sample space
  $\XX \times \YY$, write $p_{xy}$ for $\Pr[\X = x, \Y = y]$.
\end{notation}
\begin{defn}
  Given two jointly distributed random variables $(\X,\Y)$ over sample space
  $\XX \times \YY$, define the \term{mutual information} $I(\X : \Y)$ by
  \begin{align*}
    I(\X : \Y) & = H(\X) + H(\Y) - H((\X,\Y)) \\
               & = H(\X) - H(\X \mid \Y)      \\
               & = H(\Y) - H(\Y \mid \X)
  \end{align*}
  where the \term[entropy!conditional]{conditional entropy} $H(\X \mid \Y)$ is
  \[ \sum_{y \in \YY} p_y \cdot H((\X|_{\Y=y})) \]
\end{defn}
This is entirely analogous to saying that
$\abs{A \cap B} = \abs{A} + \abs{B} - \abs{A \cup B} = \abs{A} - \abs{A \setminus B}$.

\begin{theorem}[chain rule for entropy]\label{thm:chain}
  Given two jointly distributed random variables $(\X,\Y)$
  over a discrete sample space $\XX \times \YY$,
  \[ H((\X,\Y)) = H(\X) + H(\Y \mid \X) \]
\end{theorem}
\begin{prf}
  Do a bunch of algebra:
  \begin{align*}
    H(\X) + H(\Y\mid\X)
     & = \sum_{x\in\XX}p_x\log\frac{1}{p_x} + \sum_{x\in\XX}p_x \sum_{y\in\YY} \Pr[\Y=y\mid\X=x]\log\frac{1}{\Pr[\Y=y\mid\X=x]}           \\
     & = \sum_{x\in\XX}p_x\log\frac{1}{p_x} + \sum_{x\in\XX}\cancel{p_x} \sum_{y\in\YY} \frac{p_{xy}}{\cancel{p_x}}\log\frac{p_x}{p_{xy}} \\
     & = \sum_{\substack{x\in\XX\br y\in\YY}}p_{xy}\log\frac{1}{p_x} + \sum_{\substack{x\in\XX\br y\in\YY}} p_{xy}\log\frac{p_x}{p_{xy}}  \\
     & = \sum_{\substack{x\in\XX\br y\in\YY}}p_{xy}\qty(\log\frac{1}{p_x} + \log\frac{p_x}{p_{xy}})                                       \\
     & = \sum_{\substack{x\in\XX\br y\in\YY}}p_{xy}\log\frac{1}{p_{xy}}                                                                   \\
     & = H((\X,\Y)) \qedhere
  \end{align*}
\end{prf}
\begin{corollary}
  For two independent variables, since $(\Y \mid \X) = \Y$,
  we have $H((\X,\Y)) = H(\X) + H(\Y)$ as expected.
\end{corollary}
\begin{corollary}
  $H((\X_1,\X_2,\X_3)) = H(\X_1) + H(\X_2 \mid \X_1) + H(\X_3 \mid (\X_1,\X_2))$
\end{corollary}
\begin{prf}
  Consider $(\X_1,\X_2,\X_3) = ((\X_1,\X_2),\X_3)$.
  Then, by the \nameref{thm:chain},
  \[ H(((\X_1,\X_2),\X_3)) = H((\X_1,\X_2)) + H(\X_3 \mid (\X_1,\X_2)) \]
  and then by another application,
  \[ H(((\X_1,\X_2),\X_3)) = H(\X_1) + H(\X_2 \mid \X_1) + H(\X_3 \mid (\X_1,\X_2)) \]
  as desired.
\end{prf}
\begin{theorem}[general chain rule for entropy]
  For $k$ random variables $\X_1,\dotsc,\X_k$,
  \[ H((\X_1,\dotsc,\X_k)) = \sum_{i=1}^k H(\X_i \mid (\X_1,\cdots,\X_{i-1})) \]
\end{theorem}
\begin{prf}
  By induction on the \nameref{thm:chain}.
\end{prf}

\begin{notation}
  Although relative entropy is defined only on \emph{distributions},
  write $\D\X\Y$ to be $\D{f_{\X}}{f_{\Y}}$.
\end{notation}

\begin{theorem}[chain rule for relative entropy]\label{thm:chainD}
  Let $p$ and $q : \XX\times\YY \to [0,1]$ be distributions.
  Let $p(x) \coloneqq \sum_{y\in\YY} p(x,y)$ denote marginals of $p$
  and $p(y|x) \coloneqq \frac{p(x,y)}{p(x)}$ denote conditionals of $p$.
  Then,
  \begin{align*}
    \D{p(x,y)}{q(x,y)}
     & = \D{p(x)}{q(x)} + \D{p(y|x)}{q(y|x)}                                                   \\
     & = \D{p(x)}{q(x)} + \sum_{x\in\XX} p(x) \cdot \D{(p(y|x))_{y\in\YY}}{(q(y|x))_{y\in\YY}}
  \end{align*}
  where $\D{p(y|x)}{q(y|x)}$
  is the \term[entropy!relative!conditional]{conditional relative entropy}.

  Equivalently, let $(\X_1,\Y_1)$ and $(\X_2,\Y_2)$ be two joint random variables.
  Then,
  \[
    \D{(\X_1,\Y_1)}{(\X_2,\Y_2)}
    = \D{\X_1}{\X_2} + \sum_{x\in\XX}\Pr[\X_1=x]\cdot\D{\Y_1|_{\X_1=x}}{\Y_2|_{\X_2=x}}
  \]
\end{theorem}
\begin{prf}[for distributions]
  Do algebra:
  \begin{align*}
        & \D{p(x)}{q(x)} + \D{p(y \mid x)}{q(y \mid x)}                                                                                                \\
    ={} & \sum_{x\in\XX} p_x \log \frac{p_x}{q_x} + \sum_{x\in\XX}p_x\sum_{y\in\YY}p(y\mid x) \log\frac{p(y\mid x)}{q(y\mid x)}                        \\
    ={} & \sum_{x\in\XX} p_x \log \frac{p_x}{q_x} + \sum_{x\in\XX}p_x\sum_{y\in\YY}\frac{p_{xy}}{p_x} \log\frac{p_{xy}q_x}{q_{xy}p_x}                  \\
    ={} & \sum_{\substack{x\in\XX\br y\in\YY}} p_{xy} \log \frac{p_x}{q_x} + \sum_{\substack{x\in\XX\br y\in\YY}}p_{xy}\log\frac{p_{xy}q_x}{q_{xy}p_x} \\
    ={} & \sum_{\substack{x\in\XX\br y\in\YY}} p_{xy} \qty(\log \frac{p_x}{q_x} + \log\frac{p_{xy}q_x}{q_{xy}p_x})                                     \\
    ={} & \sum_{\substack{x\in\XX\br y\in\YY}} p_{xy} \log\frac{p_{xy}}{q_{xy}}                                                                        \\
    ={} & \D{p(x,y)}{q(x,y)}
  \end{align*}
  as in the proof of \nameref{thm:chain}.
\end{prf}
\begin{fact}
  \[ I[\X : \Y] = \E_{x \gets \X}[\D{\Y|_{\X=x}}{\Y}] = \sum_{x\in\XX}p_x\D{\Y|_{\X=x}}{\Y} \]
\end{fact}
\begin{prf}
  First, claim that
  \[
    I[\X : \Y] = \D{(\X,\Y)}{\tilde\X \otimes \tilde\Y}
    \nr{eq:claim1}
  \]
  where $\tilde\X \otimes \tilde\Y$ denotes a random variable consisting of
  $\tilde\X$ (resp.\ $\tilde\Y$) independently sampled
  according to the distribution of $\X$ (resp.\ $\Y$)
  so that $\Pr[\tilde\X=x,\tilde\Y=y]=p_x p_y$. Expand the left-hand side:
  \begin{align*}
    I[\X : \Y]
     & = \sum_{x\in\XX} p_x \log\frac1{p_x} + \sum_{y\in\YY} p_y \log\frac1{p_y} - \sum_{\substack{x\in\XX\br y\in\YY}}p_{xy}\log\frac1{p_{xy}}                   \\
     & = \sum_{x\in\XX}\sum_{y\in\YY} p_{xy} \log\frac1{p_x} + \sum_y\sum_x p_{xy} \log\frac1{p_y} - \sum_{\substack{x\in\XX\br y\in\YY}}p_{xy}\log\frac1{p_{xy}} \\
     & = \sum_{x\in\XX}\sum_{y\in\YY} p_{xy} \qty(\log\frac1{p_x} + \log\frac1{p_y} - \log\frac1{p_{xy}})                                                         \\
     & = \sum_{\substack{x\in\XX\br y\in\YY}} p_{xy} \log\frac{p_{xy}}{p_x p_y}                                                                                   \\
     & = \D{(\X,\Y)}{\tilde\X \otimes \tilde\Y}
  \end{align*}
  Now, apply the \nameref{thm:chainD}:
  \begin{align*}
    \D{(\X,\Y)}{\tilde\X \otimes \tilde\Y}
     & = \D{\X}{\tilde\X} + \D{(\X,\Y)\mid(\X,\tilde\X)}{(\tilde\X\oplus\tilde\Y)\mid(\X,\tilde\X)} \\
     & = 0 + \sum_x p_x \D{\Y|_{\X=x}}{\Y}                                                          \\
     & = \E_{x\gets\X}\D{\Y|_{\X=x}}{\Y} \qedhere
  \end{align*}
\end{prf}

\skipto[lecture]{11}
\lecture{June 10}
\begin{theorem}[chain rule for mutual information]
  Let $\X_1$, $\X_2$, and $\Y$ be random variables. Then,
  \[ I((\X_1,\X_2) : \Y) = I(\X_1 : Y) + I(\X_2 : (Y \mid \X_1)) \]
  and in general
  \[ I((\X_1,\dotsc,\X_n) : \Y) = \sum_{i=1}^n I(\X_1 : (\Y \mid (\X_1,\dotsc,\X_{i-1}))) \]
\end{theorem}

\section{Markov chains, data processing, and sufficient statistics}
\begin{defn}
  The random variables $\X$, $\Y$, and $\rv Z$ form a \term{Markov chain}
  if the conditional distribution of $\rv Z$ depends only on $\Y$
  and is conditionally independent of $\X$. Equivalently,
  \[ \Pr[\X=x,\Y=y,\rv Z=z] = \Pr[\X=x]\cdot\Pr[\Y=y\mid\X=x]\cdot\Pr[\rv Z=z\mid\Y=y] \]
  Then, we write $\X \to \Y \to \rv Z$.
\end{defn}

\begin{example}[Legend of the Drunken Master]
  In $\Omega = \R^2$, Jackie Chan is drunk and takes steps in random directions.
  He starts at $\rv J_0 = (0,0)$.
  Then, $\rv J_1 = \rv J_0 + d_1$ where $d_1$ is an independent random unit vector in $\R^2$,
  and $\rv J_2 = \rv J_1 + d_2$ and so on.
\end{example}

First, $\rv J_3$ and $\rv J_1$ are not independent.
But if we fix $\rv J_2 = j_2 \in \R^2$, then $\rv J_1 \mid \rv J_2=j_2$
and $\rv J_3 \mid \rv J_2=j_2$ are independent.
In fact, they are uniformly distributed random points on the circle of radius 1
centred at $j_2$.

\begin{prop}
  Let $\X$, $\Y$, and $\rv Z$ be random variables. \TFAE:
  \begin{enumerate}
    \item $\X \to \Y \to \rv Z$
    \item $\X$ and $\rv Z$ are conditionally independent given $\Y$.
          That is,
          \[
            \Pr[\X=x,\rv Z=z \mid \Y=y] = \Pr[\X=x \mid \Y=y] \cdot \Pr[\rv Z=z \mid \Y=y]
          \]
    \item $\rv Z$ is distributed according to $f(\Y,\rv R)$ for some $\rv R$ independent of $\X$ and $\Y$.
  \end{enumerate}
\end{prop}
\begin{xca}
  Prove the definitions are equivalent.
\end{xca}

\begin{theorem}[data-processing inequality]\label{thm:dpi}
  If $\X \to \Y \to \rv Z$, then $I(\X : \rv Z) \leq I(\X : \Y)$.

  Equality happens if and only if $\X \to \rv Z \to \Y$.
\end{theorem}
\begin{prf}
  By the chain rule,
  \[
    I(\X : (\Y, \rv Z)) = I(\X : \Y) + \cancelto{0}{I(\X : \rv Z \mid \Y)}
    = I(\X : \rv Z) + I(\X : \Y \mid \rv Z)
  \]
  so that
  \[ I(\X : \Y) = I(\X : \rv Z) + I(\X : \Y \mid \rv Z) \]
  One may show that the mutual information is always non-negative,
  so we have $I(\X : \Y) \geq I(\X : \rv Z)$ as desired.
\end{prf}

\section{Communication complexity}
\skipto[lecture]{10}
\lecture{June 5}
\begin{problem}
  Suppose there is a joint distribution $(\X,\Y)$ that Alice and Bob wish to
  jointly compute. Alice and Bob have access to a shared random string $\rv R = (\rv R_i)$.
  Alice is given $x\in\XX$ and wants to send Bob a prefix-free message of minimum length
  so that Bob can compute a sample from $\Y \mid \X=x$.
\end{problem}

\begin{defn}
  A \term*{protocol} $\Pi$ is a pair of functions $(M,y)$ where
  $M : \XX\times\Omega_{\rv R} \to \bits*$ is the message Alice sends to Bob
  and $y : \bits*\times\Omega_{\rv R} \to \YY$ is Bob's output.

  The \term*{performance} of $\Pi$ is $\E_{\X,\rv R}\abs{M(\rv X,\rv R)}$
\end{defn}

Suppose $\X$ and $\Y$ are independent.
Then, Bob needs no information so we can use the trivial protocol
$M(\X,\rv R) = \varnothing$ with performance 0.

Otherwise, we can use a strategy of prefix-free encoding $x$
so that $\E\abs{M(\X,\rv R)} \approx H(\X)$.

\begin{theorem}
  There exists a protocol $\Pi = (M,y)$ such that expected message length
  \[ \E\abs{M(\X,\rv R)} \leq I(\X : \Y) + \order{\log I(\X : \Y)} \]
  For all other protocols $\Pi' = (M',y')$,
  \[ \E\abs{M'(\X,\rv R)} \geq I(\X : \Y) \]
\end{theorem}
\begin{prf}
  Let $\X$ be a random point on the hypercube $\{\pm1\}^n$.
  Let $\Y$ be a random point on $\{\pm1\}^n$ that is $\varepsilon$-correlated with $\X$.
  That is, $\Y_i = \X_i$ with probability $\varepsilon$
  and is uniformly random otherwise.

  Observe that, individually, $\X$ and $\Y$ have the same distribution.
  In particular, in the $\varepsilon$ case, then $\Y_i = \X_i$ is $\Unif\{\pm1\}$.
  In the $1-\varepsilon$ case, $\Y_i \sim \Unif\{\pm1\}$ by definition.

  We can calculate $H(\X) = H(\Y) = n$.

  Also, $H(\Y\mid\X) = \sum_{x} p_x H(\Y\mid\X=x) \approx (1-\varepsilon)n$.
  One can show that $\Y\mid\X=x$ is approximately uniformly distributed
  over the vectors of length $n$ that agree on $\varepsilon n$ coordinates with $x$.
  This sample space has size $2^{(1-\varepsilon)n}$.

  Therefore, $I(\X:\Y) = H(\Y) - H(\Y \mid \X) \approx \varepsilon n$.

  By \cref{prop:rejworst}, there exists a rejection sampler such that
  $\E[\ell(i^*)] \leq \D P Q + \order{\log \D P Q}$.

  Recall from STAT 230 that we can transform $\rv R$ into any distribution
  with the change of variable bullshit.
  In particular, transform $\rv R_i$ to \iid $\Y_i \sim \Y$ and the biased coins.

  Alice will run \Call{RejectionSampler}{$\Y|_{\X=x},\Y$} to find a random index $i^*$
  such that $\Y_{i^*}$ has distribution $\Y|_{\X=x}$.

  Alice sends a prefix-free encoding of $i^*$. Bob outputs $\Y_{i^*}$.
  The performance is:
  \begin{align*}
    \E_{\mathclap{\X,\rv R}} \abs{M(\X,\rv R)}
     & = \sum_{x\in\XX} p_x \E_{i^*,\rv Y_1,\rv Y_2,\dotsc}[\ell(i^*)]                    \\
     & \leq \sum_{x\in\XX} p_x \qty(\D{\Y|_{\X=x}}{\Y} + \order{\log \D{\Y|_{\X=x}}{\Y}}) \\
     & = I(\X:\Y) + \sum_{x\in\XX}p_x\order{\log \D{\Y|_{\X=x}}{\Y}}                      \\
     & \leq I(\X:\Y) + \order{\log I(\X:\Y)}
  \end{align*}
  where the last step is by Jensen's inequality.

  Now, let $\Pi$ be any protocol.
  \marginnote{\normalsize{\textit{Lecture 11\\June 10\\cont.}}}
  We will apply the \nameref{thm:dpi}.

  Notice that $\X \to (M(\X,\rv R),\rv R) \to \Y$ if and only if $\Pi$
  is a valid protocol.
  If we sample $x\sim\X$ and Alice sends $M(x,\rv R)$,
  then Bob outputs something distributed according to $\Y \mid \X=x$,
  i.e., just $\Y$ since $x$ was arbitrary. Then,
  \begin{align*}
    I(\X : \Y)
     & \leq I(\X : (M(\X,\rv R),\rv R)) \tag{data processing inequality}                                          \\
     & = I(\X : \rv R) + \sum_{r\in\Omega_{\rv R}} p_r I(\X|_{\rv R=r} : M(\X,\rv R)|_{\rv R=r}) \tag{chain rule} \\
     & = 0 + I(\X : M(\X,\rv R) \mid \rv R) \tag{independence}                                                    \\
     & \leq H(M(\X,\rv R) \mid \rv R) \tag{$I(\rv A : \rv B) \leq \min\{H(\rv A),H(\rv B)\}$}                     \\
     & \leq H(M(\X,\rv R)) \tag{$H(\rv A \mid \rv B) \leq H(\rv A)$}                                              \\
     & \leq \E\abs{M(\X,\rv R)} \tag{Kraft inequality}
  \end{align*}
  completing the proof.
\end{prf}

\section{Parameter estimation}

\pagebreak
\phantomsection\addcontentsline{toc}{chapter}{Back Matter}
\renewcommand{\listtheoremname}{List of Named Results}
\phantomsection\addcontentsline{toc}{section}{\listtheoremname}
\listoftheorems[ignoreall,numwidth=4em,onlynamed={theorem,lemma,corollary,prop}]
\printindex

\end{document}
